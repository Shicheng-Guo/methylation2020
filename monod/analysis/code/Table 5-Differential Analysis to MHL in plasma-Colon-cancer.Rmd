---
title: "Differential Analysis to MHL in plasma"
author: "Shicheng Guo"
date: "Wednesday, March 30, 2016"
output: html_document
---

```{r}
ggbarplot<-function(data){
library("ggplot2")
newdata<-data.frame(value=as.numeric(data.matrix(data)),Group=rep(colnames(data),each=nrow(data)))
myData <- aggregate(newdata$value,by =list(type=newdata$Group),
                    FUN = function(x) c(mean = mean(x,na.rm=T),
                                        sd = sd(x,na.rm=T),
                                        sem=sd(x,na.rm=T)/sqrt(length(na.omit(x))),
                                        min=min(x,na.rm=T),
                                        max=max(x,na.rm=T),
                                        median=median(x,na.rm=T),
                                        me=qt(1-0.05/2,df=length(na.omit(x))*sd(x,na.rm=T)/sqrt(length(na.omit(x)))))
)
myData <- do.call(data.frame, myData)
colnames(myData)=c("type","mean","sd","sem","min","max","median","me")
ggplot<-ggplot(myData, aes(x =type, y = mean)) +
  geom_bar(position = position_dodge(), stat="identity", fill="blue",width=0.8) +
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),size=1.0) +
  theme_bw() +
  theme(panel.grid.major = element_blank())+
  coord_flip()+
  theme(axis.text=element_text(size=10),axis.title=element_text(),axis.text.y = element_text(hjust=0))
return(ggplot)
}

ggboxplot<-function(data){
library("ggplot2")
newdata<-data.frame(value=as.numeric(data.matrix(data)),Group=rep(colnames(data),each=nrow(data)))
ggplot<-ggplot(newdata, aes(factor(Group),value)) +
  geom_boxplot(aes(fill = factor(Group)),outlier.shape=NA)+
  coord_flip()+
  theme(axis.text=element_text(size=10),axis.title=element_text(),axis.text.y = element_text(hjust=0),legend.position="none")
return(ggplot)
}


ColNARemove<-function(data,missratio=0.3){
  threshold<-(missratio)*dim(data)[1]
  NaCol<-which(apply(data,2,function(x) sum(is.na(x))>threshold))
  zero<-which(apply(data,2,function(x) all(x==0))==T)
  NaCOL<-c(NaCol,zero)
  if(length(NaCOL)>0){
    data1<-data[,-NaCOL]
  }else{
    data1<-data;
  }
  data1
}   

RawNARemove<-function(data,missratio=0.3){
  threshold<-(missratio)*dim(data)[2]
  NaRaw<-which(apply(data,1,function(x) sum(is.na(x))>threshold))
  zero<-which(apply(data,1,function(x) all(x==0))==T)
  NaRAW<-c(NaRaw,zero)
  if(length(NaRAW)>0){
    dat<-data[-NaRAW,]
  }else{
    dat<-data;
  }
  dat
}   

ttestFunction<-function(data,x1,x2){
  output<-matrix(NA,dim(data)[1],5)
  for(i in 1:dim(data)[1]){
    out<-data.frame()
    if(all(! any(all(is.na(data[i,x1])),length(na.omit(data[i,x1]))<2,length(na.omit(data[i,x2]))<2,all(is.na(data[i,x2]))),sum(is.na(data[i,]))<0.5*length(data[i,]))){ 
      tmp1<-try(t.test(as.numeric(data[i,x1]),as.numeric(data[i,x2]), na.action=na.omit))
      output[i,1]<-tmp1$p.value
      output[i,2]<-as.numeric((mean(as.numeric(data[i,x1]),na.rm=T)-mean(as.numeric(data[i,x2]),na.rm=T)))
      output[i,3]<-"t-test"
      output[i,4]<-mean(as.numeric(data[i,x1]),na.rm=T)
      output[i,5]<-mean(as.numeric(data[i,x2]),na.rm=T)
      print(i)
    }
  }
  out<-cbind(rownames(data),output)
  P.Adj<-p.adjust(output[,1],method="fdr")
  out<-data.frame(out[,1],out[,2],P.Adj,out[,3:6])
  colnames(out)=c("RowName","P-value","P.FDR","Delta","Test","M(G1)","M(G2)")
  return(out)
}
```


```{r}
setwd("C:\\Users\\shicheng\\Dropbox\\Project\\methylation\\monod\\analysis\\MHL-March30-2016")
setwd("/oasis/tscc/scratch/shg047/monod/hapinfo")
load("MONOD-Apr6.MHL.RData")
load("monod.mhl.may5.RData")

sum(is.na(data))/(nrow(data)*ncol(data))
# re-group/collect the samples #colon cancer
Group<-colnames(data)
# Group[grep("CTR|NC-|Pregn",Group)]<-"NP"
Group[grep("NC-",Group)]<-"NP-Kun"
Group[grep("CTR|Pregn",Group)]<-"NP-Dennis"
Group[grep("6-P",Group)]<-"CCP"
Group[grep("6-T|HCT116|Colon_Tumor_Primary|CTT|metastasis_colon|tumor_colon",Group)]<-"CCT"
Group[grep("normal_colon|N37-Colon|SG-01",Group)]<-"NCT"

Group[grep("7-P",Group)]<-"LCP"
Group[grep("7-T|adenocarcinoma_lung|tumor_lung",Group)]<-"LCT"
Group[grep("LG-01|N37-Lung|normal_lung",Group)]<-"NLT"

Group[grep("PC-P",Group)]<-"PCP"
Group[grep("PC-T",Group)]<-"PCT"
Group[grep("PA-01|N37-Pancreas",Group)]<-"NPT"

Group[grep("WB",Group)]<-"WB"
Group[grep("STL|N37|methylC",Group)]<-"ONT"
newdata<-data
colnames(newdata)<-Group
newdata<-data.frame(newdata,check.names=F)
colnames(newdata)
```
# check the distribution for all the samples (2 normal plasma were removed because the MHL were not quite similar with other samples??)
```{r}
DataMatrix=data
MatrixDataSummary<-function(DataMatrix){
DataMatrix<-data.matrix(DataMatrix)
DataMatrix<-data.frame(value=as.numeric(DataMatrix),Group=rep(colnames(DataMatrix),each=nrow(DataMatrix)))
myData <- aggregate(DataMatrix$value,by =list(type=DataMatrix$Group),
                    FUN = function(x) c(mean = mean(x,na.rm=T), 
                                        sd = sd(x,na.rm=T),
                                        sem=sd(x,na.rm=T)/sqrt(length(na.omit(x))),
                                        me=qt(1-0.05/2,df=length(na.omit(x))*sd(x,na.rm=T)/sqrt(length(na.omit(x))))),
)
myData <- do.call(data.frame, myData)
colnames(myData)=c("type","mean","sd","sem","me")
myData
}
Summary<-MatrixDataSummary(data)
write.table(Summary,file="MatrixDataSummary.MONOD.txt",sep="\t",col.names=NA,row.names=T,quote=F)
```

# colon cancer
107 regions were selected with the very common fitler in colon plasma datasat: Mean(CT)>0.3 & Mean(NP)<0.1 & Mean(WB)<0.1

```{r}
# YY<-grep("NP|CCP|CCT|NCT|WB|ONT",Group)
# YY<-grep("NP|CCP|CCT|NCT",Group)
YY<-grep("NP-Kun|CCP",Group)
newdata<-newdata[,YY]
# Check the missing value caused by RRBS (since MHB is from WGBS)
NumNANP<-apply(newdata[,31:105],1,function(x) sum(is.na(x)))
NumNACP<-apply(newdata[,1:30],1,function(x) sum(is.na(x)))
par(mfrow=c(2,2))
hist(NumNANP,col="blue",cex.main=0.75,main=c("Normal Plasma"),xlab="Numbers of missing value")
hist(NumNACP,col="blue",cex.main=0.75,main=c("Cancer Plasma"),xlab="Numbers of missing value")
colnames(newdata)
mydata<-newdata
mydata<-RawNARemove(Newdata)
dim(mydata)
mydata<-ColNARemove(mydata)
dim(mydata)

# Check the Differentila MHB regions between NP and CP
idx<-sapply(colnames(newdata),function(x) unlist(strsplit(x,"[.]"))[1])
colnames(newdata)<-idx
newdata<-data.matrix(newdata)
head(newdata)
colnames(newdata)
dim(newdata)
Newdata<-newdata[,c(grep("CCP",colnames(newdata)),grep("NP-Kun",colnames(newdata)))]
table(colnames(Newdata))
dim(Newdata)
colnames(Newdata)
x1<-grep("CCP",colnames(Newdata))
x2<-grep("NP-Kun",colnames(Newdata))
Rlt<-ttestFunction(Newdata,x1,x2)
head(Rlt)
dim(Rlt)
sig<-subset(Rlt,P.FDR<0.5)
dim(sig)
write.table(sig,file="colon.cancer.plasma.vs.normal.plasma.significant.txt",col.names=T,row.names=F,sep="\t",quote=F)

xx<-cbind(colnames(Newdata),t(Newdata[rownames(sig),]))

xx<-data.frame(colnames(Newdata),Newdata[match(sig[6,1],rownames(Newdata)),])
colnames(xx)<-c("phen","MHL")
library("ggplot2")
pdf("zz.pdf")
ggplot(xx,aes(phen,MHL))+geom_boxplot()+geom_jitter()+theme_bw()
dev.off()

for(i in 1:12){
xx<-data.frame(colnames(Newdata),Newdata[match(sig[i,1],rownames(Newdata)),])
colnames(xx)<-c("phen","MHL")
library("ggplot2")
file=paste("f",i,"pdf",sep=".")
q<-ggplot(xx,aes(phen,MHL))+geom_boxplot()+geom_jitter()+theme_bw()
pdf(file)
print(q)
dev.off()
}

# Heatmap for all signficant differential biomarkers(with missing value)
sig<-subset(Rlt,P.FDR<0.05 & abs(as.numeric(as.character(Delta))>0.2))
tmp<-Newdata[match(sig[,1],rownames(Newdata)),]
# x<-grep("CCP",colnames(tmp))
# x1<-apply(tmp[,x],1,function(x) sum(na.omit(x)>0.5)>0.6*length(na.omit(x)))
# tmp<-tmp[-which(x1),]
dim(tmp)
colnames(tmp)
colnames(tmp)<-c(rep("CCP",30),rep("NP",length(grep("NP-Kun",colnames(tmp)))))
library("gplots")
pdf("colon.sig.heatmap.pdf")
heatmap.2(tmp,trace="none",cexRow = 0.25,cexCol = 0.8, density.info="none",col="greenred",Colv=F,keysize=0.8, margins = c(5, 10))
dev.off()

sig<-subset(Rlt,P.FDR<0.05 & as.numeric(as.character(Delta))>0.42)
sig<-sig[order(as.numeric(as.character(sig$Delta)),decreasing=T),]
head(sig)
colnames(sig)<-c("RowName","P-value","P.FDR","Delta","Test","M(Cancer-Plasma)","M(Normal-Plasma)")
dim(sig)
write.table(sig,file="colon.cancer.plasma.vs.normal.plasma.significant.txt",col.names=T,row.names=F,sep="\t",quote=F)

# Heatmap for all signficant differential biomarkers(with missing value)
sig<-subset(Rlt,P.FDR<0.05 & abs(as.numeric(as.character(Delta))>0.2))
tmp<-Newdata[match(sig[,1],rownames(Newdata)),]
x<-grep("CCP",colnames(tmp))
x1<-apply(tmp[,x],1,function(x) sum(na.omit(x)>0.5)>0.6*length(na.omit(x)))
tmp<-tmp[-which(x1),]
dim(tmp)
colnames(tmp)<-c(rep("CCP",30),rep("NP",length(grep("NP-Kun",colnames(tmp)))))
library("gplots")
pdf("colon.sig.heatmap.pdf")
heatmap.2(tmp,trace="none",cexRow = 0.25,cexCol = 0.6, density.info="none",col="greenred",Colv=F,keysize=0.8, margins = c(5, 10))
dev.off()
write.table(tmp,file="most.signficant.66.colon.cancer.plasma.vs.normal.plasma.significant.txt",col.names=NA,row.names=T,sep="\t",quote=F)


# Heatmap for most signficant differential biomarkers(with missing value)
sig<-subset(Rlt,P.FDR<0.05 & abs(as.numeric(as.character(Delta))>0.1))
tmp<-Newdata[match(sig[,1],rownames(Newdata)),]
x<-grep("CCP",colnames(tmp))
x1<-apply(tmp[,x],1,function(x) sum(na.omit(x)>0.5)>0.6*length(na.omit(x)))
tmp<-tmp[-which(x1),]
dim(tmp)
colnames(tmp)<-c(rep("CCP",30),rep("NP",length(grep("NP-Kun",colnames(tmp)))))

library("gplots")
pdf("colon.sig.heatmap.pdf")
heatmap.2(tmp,trace="none",cexRow = 0.25,cexCol = 0.6, density.info="none",col="greenred",Colv=F,keysize=0.8, margins = c(5, 10))
dev.off()
write.table(tmp,file="most.signficant.66.colon.cancer.plasma.vs.normal.plasma.significant.txt",col.names=NA,row.names=T,sep="\t",quote=F)

# SEPT9
# bedtools intersect -wao -a colon.cancer.plasma.vs.normal.plasma.significant.txt -b hg19_refGene.bed > colon.cancer.sig.mhl.sorted.Annotated.txt
loc<-"chr1:25258448-25258484"  # RUNX3
thres<-0.3

loc<-"chr17:75283831-75283978" # SEPT9
thres<-0.6

Newdata[grep(loc,rownames(Newdata)),]
x1<-length(which(na.omit(Newdata[grep(loc,rownames(Newdata)),grep("CCP",colnames(Newdata))]>thres)))
x2<-length(which(! na.omit(Newdata[grep(loc,rownames(Newdata)),grep("CCP",colnames(Newdata))]>thres)))
x3<-length(which(na.omit(Newdata[grep(loc,rownames(Newdata)),grep("NP-Kun",colnames(Newdata))]>thres)))
x4<-length(which(! na.omit(Newdata[grep(loc,rownames(Newdata)),grep("NP-Kun",colnames(Newdata))]>thres)))

1-x2/(x1+x2)
1-x3/(x3+x4)
```

Lung cancer classic biomarker. 

```{r}
YY<-grep("NP-Kun|LCP",Group)
newdata<-newdata[,YY]
idx<-sapply(colnames(newdata),function(x) unlist(strsplit(x,"[.]"))[1])
colnames(newdata)<-idx
newdata<-data.matrix(newdata)
head(newdata)
colnames(newdata)
dim(newdata)
Newdata<-newdata[,c(grep("LCP",colnames(newdata)),grep("NP-Kun",colnames(newdata)))]
table(colnames(Newdata))
dim(Newdata)
Newdata<-RawNARemove(Newdata)

x1<-grep("LCP",colnames(Newdata))
x2<-grep("NP-Kun",colnames(Newdata))
x1
x2

Rlt<-ttestFunction(Newdata,x1,x2)
dim(Rlt)

sig<-subset(Rlt,P.FDR<0.05)
dim(sig)
sig<-subset(Rlt,P.FDR<0.05 & abs(as.numeric(as.character(Delta)))>0.2)
# Heatmap for most signficant differential biomarkers(with missing value)
tmp<-Newdata[match(sig[,1],rownames(Newdata)),]
x<-grep("LCP",colnames(tmp))
#x1<-apply(tmp[,x],1,function(x) sum(na.omit(x)>0.6)>0.6*length(na.omit(x)))
#tmp<-tmp[-which(x1),]
dim(tmp)
colnames(tmp)<-c(rep("LCP",29),rep("NP",26))
library("gplots")
pdf("lung.sig.heatmap.pdf")
heatmap.2(tmp,trace="none",cexRow = 0.55,cexCol = 0.8, density.info="none",col="greenred",Colv=F,keysize=0.8, margins = c(5, 10))
dev.off()
write.table(tmp,file="most.signficant.66.lung.cancer.plasma.vs.normal.plasma.significant.txt",col.names=NA,row.names=T,sep="\t",quote=F)


sig<-sig[order(as.numeric(as.character(sig$Delta)),decreasing=T),]
head(sig)
colnames(sig)<-c("RowName","P-value","P.FDR","Delta","Test","M(Cancer-Plasma)","M(Normal-Plasma)")
dim(sig)
write.table(sig,file="lung.cancer.plasma.vs.normal.plasma.significant.txt",col.names=T,row.names=F,sep="\t",quote=F)


# Heatmap for most signficant differential biomarkers(with missing value)
sig<-subset(Rlt,P.FDR<0.05 & abs(as.numeric(as.character(Delta))>0.1))
tmp<-Newdata[match(sig[,1],rownames(Newdata)),]
x<-grep("LCP",colnames(tmp))
x1<-apply(tmp[,x],1,function(x) sum(na.omit(x)>0.6)>0.6*length(na.omit(x)))
tmp<-tmp[-which(x1),]
dim(tmp)
colnames(tmp)<-c(rep("LCP",29),rep("NP",26))

library("gplots")
pdf("lung.sig.heatmap.pdf")
heatmap.2(tmp,trace="none",cexRow = 0.55,cexCol = 0.6, density.info="none",col="greenred",Colv=F,keysize=0.8, margins = c(5, 10))
dev.off()
write.table(tmp,file="most.signficant.66.lung.cancer.plasma.vs.normal.plasma.significant.txt",col.names=NA,row.names=T,sep="\t",quote=F)

# SEPT9
# bedtools intersect -wao -a lung.cancer.plasma.vs.normal.plasma.significant.txt -b hg19_refGene.bed > lung.cancer.sig.mhl.sorted.Annotated.txt
loc<-"chr1:25258448-25258484"  # RUNX3
thres<-0.3

loc<-"chr17:75283831-75283978" # SEPT9
thres<-0.6

Newdata[grep(loc,rownames(Newdata)),]
x1<-length(which(na.omit(Newdata[grep(loc,rownames(Newdata)),grep("CCP",colnames(Newdata))]>thres)))
x2<-length(which(! na.omit(Newdata[grep(loc,rownames(Newdata)),grep("CCP",colnames(Newdata))]>thres)))
x3<-length(which(na.omit(Newdata[grep(loc,rownames(Newdata)),grep("NP-Kun",colnames(Newdata))]>thres)))
x4<-length(which(! na.omit(Newdata[grep(loc,rownames(Newdata)),grep("NP-Kun",colnames(Newdata))]>thres)))

1-x2/(x1+x2)
1-x3/(x3+x4)
```



Pancreatic cancer classic biomarker. 

```{r}
YY<-grep("NP-Kun|PCP",Group)
newdata<-newdata[,YY]
newdata<-newdata[,-c(25,26)]
head(newdata[,24:27])
idx<-sapply(colnames(newdata),function(x) unlist(strsplit(x,"[.]"))[1])
colnames(newdata)<-idx
newdata<-data.matrix(newdata)
head(newdata)
colnames(newdata)
dim(newdata)
Newdata<-newdata[,c(grep("NP-Kun",colnames(newdata)),grep("PCP",colnames(newdata)))]
table(colnames(Newdata))
dim(Newdata)

x1<-grep("PCP",colnames(Newdata))
x2<-grep("NP-Kun",colnames(Newdata))
x1
x2

Rlt<-ttestFunction(Newdata,x1,x2)
head(Rlt)

sig<-subset(Rlt,P.FDR<0.05 & abs(as.numeric(as.character(Delta)))>0.2)
dim(sig)
write.table(sig,file="pancreatic.cancer.plasma.vs.normal.plasma.significant.txt",col.names=T,row.names=F,sep="\t",quote=F)
# Heatmap for most signficant differential biomarkers(with missing value)
tmp<-Newdata[match(sig[,1],rownames(Newdata)),]
dim(tmp)
table(colnames(tmp))
colnames(tmp)<-c(rep("NP",24),rep("PCP",10))

library("gplots")
pdf("pancreastic.sig.heatmap.pdf")
heatmap.2(tmp,trace="none",cexRow = 0.45,cexCol = 0.8, density.info="none",col="greenred",Colv=F,keysize=0.8, margins = c(5, 10))
dev.off()
write.table(tmp,file="most.signficant.66.pancreastic.cancer.plasma.vs.normal.plasma.significant.txt",col.names=NA,row.names=T,sep="\t",quote=F)




sig<-subset(Rlt,P.FDR<0.05 & as.numeric(as.character(Delta))>0.5)
sig<-sig[order(as.numeric(as.character(sig$Delta)),decreasing=T),]
head(sig)
colnames(sig)<-c("RowName","P-value","P.FDR","Delta","Test","M(Cancer-Plasma)","M(Normal-Plasma)")
dim(sig)
write.table(sig,file="lung.cancer.plasma.vs.normal.plasma.significant.txt",col.names=T,row.names=F,sep="\t",quote=F)

# Heatmap for most signficant differential biomarkers(with missing value)
sig<-subset(Rlt,P.FDR<0.05 & abs(as.numeric(as.character(Delta))>0.5))
tmp<-Newdata[match(sig[,1],rownames(Newdata)),]
x<-grep("NP-Kun",colnames(tmp))
x1<-apply(tmp[,x],1,function(x) sum(na.omit(x)>0.1)>0.1*length(na.omit(x)))
sum(x1)
if(sum(x1)>0){
tmp<-tmp[-which(x1),]
}
dim(tmp)
table(colnames(tmp))
colnames(tmp)<-c(rep("NP",24),rep("PCP",10))

library("gplots")
pdf("pancreastic.sig.heatmap.pdf")
heatmap.2(tmp,trace="none",cexRow = 0.45,cexCol = 0.6, density.info="none",col="greenred",Colv=F,keysize=0.8, margins = c(5, 10))
dev.off()
write.table(tmp,file="most.signficant.66.pancreastic.cancer.plasma.vs.normal.plasma.significant.txt",col.names=NA,row.names=T,sep="\t",quote=F)

# SEPT9
# bedtools intersect -wao -a lung.cancer.plasma.vs.normal.plasma.significant.txt -b hg19_refGene.bed > lung.cancer.sig.mhl.sorted.Annotated.txt
loc<-"chr1:25258448-25258484"  # RUNX3
thres<-0.3

loc<-"chr17:75283831-75283978" # SEPT9
thres<-0.6

Newdata[grep(loc,rownames(Newdata)),]
x1<-length(which(na.omit(Newdata[grep(loc,rownames(Newdata)),grep("CCP",colnames(Newdata))]>thres)))
x2<-length(which(! na.omit(Newdata[grep(loc,rownames(Newdata)),grep("CCP",colnames(Newdata))]>thres)))
x3<-length(which(na.omit(Newdata[grep(loc,rownames(Newdata)),grep("NP-Kun",colnames(Newdata))]>thres)))
x4<-length(which(! na.omit(Newdata[grep(loc,rownames(Newdata)),grep("NP-Kun",colnames(Newdata))]>thres)))

1-x2/(x1+x2)
1-x3/(x3+x4)


# compare with existed biomarker

d1<-read.table("xx.target.xt",sep="\t")
d2<-read.table("colon.cancer.sig.mhl.sorted.Annotated.GeneName.txt",sep="\t")
d2[na.omit(match(d1[,1],d2[,1])),]


d1<-read.table("xx.pancrease.target.txt",sep="\t")
d2<-read.table("pancreatic.cancer.plasma.vs.normal.plasma.significant.txt.Gene.list.txt",sep="\t")
d2[na.omit(match(d1[,1],d2[,1])),]
```




```{r}
YY<-grep("NP-Kun|PCP|LCP|CCP",Group)
library("randomForest")
newdata<-newdata[,YY]
idx<-sapply(colnames(newdata),function(x) unlist(strsplit(x,"[.]"))[1])
colnames(newdata)<-idx
newdata<-data.matrix(newdata)
head(newdata)
colnames(newdata)
dim(newdata)
Newdata<-newdata[,c(grep("NP-Kun",colnames(newdata)),grep("CCP",colnames(newdata)),grep("LCP",colnames(newdata)),grep("PCP",colnames(newdata)))]
table(colnames(Newdata))
dim(Newdata)


mydata<-RawNARemove(Newdata)
mydata<-ColNARemove(mydata)
library("impute")
mydata<-impute.knn(mydata)$data
dim(mydata)

pred2<-mydata
lab2<-as.factor(colnames(mydata))

bestmtry<-tuneRF(x=t(pred2),y=lab2,ntreeTry=500, stepFactor=2, improve=0.05,trace=TRUE, plot=TRUE, doBest=T)
best.mtry=bestmtry$mtry
rf.model1<-randomForest(x=t(pred2),y=lab2,mtry=best.mtry)
rf.model1
rf.importance<-rf.importance+rf.model1$importance/100


```

```{r}
dim(colonData)
colnames(colonData)
NewData<-data.frame(value=as.numeric(colonData),Group=rep(colnames(colonData),each=nrow(colonData)))
myData <- aggregate(NewData$value,by =list(type=NewData$Group),
                    FUN = function(x) c(mean = mean(x,na.rm=T), 
                                        sd = sd(x,na.rm=T),
                                        sem=sd(x,na.rm=T)/sqrt(length(na.omit(x))),
                                        me=qt(1-0.05/2,df=length(na.omit(x))*sd(x,na.rm=T)/sqrt(length(na.omit(x)))))
)
myData <- do.call(data.frame, myData)
colnames(myData)=c("type","mean","sd","sem","me")
head(myData)

library("ggplot2")
pdf("colon.cancer.mhl.plasma.groups.107.pdf")
ylab="Average MHL"
xlab="Group"
title="Average MHL in different Groups"
myData <- within(myData,type <- factor(type,levels=c("NP-Kun","NCT","CCT","CCP")))
ggplot(myData, aes(x =type, y = mean)) +  
  geom_bar(position = position_dodge(), stat="identity", fill="blue",width=0.9) + 
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),size=1.0) +
  ggtitle(title) + 
  theme_bw() +
  theme(panel.grid.major = element_blank())+
  xlab(xlab) +
  ylab(ylab)+
  theme(axis.text=element_text(size=10),axis.title=element_text(size=10),axis.text.y = element_text(hjust=0))

dev.off()

```

Lung cancer analysis;
```{r}
# YY<-grep("NP|CCP|CCT|NCT|WB|ONT",Group)
# YY<-grep("NP|CCP|CCT|NCT",Group)
YY<-grep("NP-Kun|LCP|LCT|NCT",Group)
table(Group)
YY<-grep("NP-Kun|LCP|LCT|NLT",Group)
newdata<-newdata[,YY]
idx<-sapply(colnames(newdata),function(x) unlist(strsplit(x,"[.]"))[1])
colnames(newdata)<-idx
newdata<-data.matrix(newdata)
head(newdata)
table(colnames(newdata))
dim(newdata)
Newdata<-newdata[,c(grep("NLT",colnames(newdata)),grep("NP-Kun",colnames(newdata)),grep("LCT",colnames(newdata)),grep("LCP",colnames(newdata)))]
colnames(Newdata)
dim(Newdata)
target1.colon<-which(apply(Newdata,1,function(x) mean(x[grep("NP-Kun",colnames(Newdata))],na.rm=T)<0.1 && mean(x[grep("NLT",colnames(Newdata))],na.rm=T)<0.1 && mean(x[grep("LCT",colnames(Newdata))],na.rm=T)>0.2))  # Cancer tissue > 0 and normal plasma =0

length(target1.colon)
Newdata2=Newdata[target1.colon,]
write.table(NewData,file="Lung.cancer.tissue.hyper.txt",col.names=NA,row.names=T,quote=F,sep="\t")

colonData=Newdata2
dim(colonData)
colnames(colonData)
NewData<-data.frame(value=as.numeric(colonData),Group=rep(colnames(colonData),each=nrow(colonData)))
myData <- aggregate(NewData$value,by =list(type=NewData$Group),
                    FUN = function(x) c(mean = mean(x,na.rm=T), 
                                        sd = sd(x,na.rm=T),
                                        sem=sd(x,na.rm=T)/sqrt(length(na.omit(x))),
                                        me=qt(1-0.05/2,df=length(na.omit(x))*sd(x,na.rm=T)/sqrt(length(na.omit(x)))))
)
myData <- do.call(data.frame, myData)
colnames(myData)=c("type","mean","sd","sem","me")
head(myData)

library("ggplot2")
# pdf("Lung.cancer.mhl.plasma.groups.107.pdf")
ylab="Average MHL"
xlab="Group"
title="Average MHL in different Groups"
myData <- within(myData,type <- factor(type,levels=c("NP-Kun","NLT","LCT","LCP")))

ggplot(myData, aes(x =type, y = mean)) +  
  geom_bar(position = position_dodge(), stat="identity", fill="blue",width=0.9) + 
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),size=1.0) +
  ggtitle(title) + 
  theme_bw() +
  theme(panel.grid.major = element_blank())+
  xlab(xlab) +
  ylab(ylab)+
  theme(axis.text=element_text(size=10),axis.title=element_text(size=10),axis.text.y = element_text(hjust=0))

dev.off()


```

91 regions were selected with basic filter: M(PCT)>0.4 and M(NP)<0.05
```{r}

YY<-grep("NP-Kun|PCP|PCT|NPT",Group)
newdata<-newdata[,YY]
idx<-sapply(colnames(newdata),function(x) unlist(strsplit(x,"[.]"))[1])
colnames(newdata)<-idx
newdata<-data.matrix(newdata)
head(newdata)
table(colnames(newdata))
dim(newdata)
Newdata<-newdata[,c(grep("NPT",colnames(newdata)),grep("NP-Kun",colnames(newdata)),grep("PCT",colnames(newdata)),grep("PCP",colnames(newdata)))]
colnames(Newdata)
dim(Newdata)
target1.colon<-which(apply(Newdata,1,function(x) mean(x[grep("NP-Kun",colnames(Newdata))],na.rm=T)<0.05 && mean(x[grep("NPT",colnames(Newdata))],na.rm=T)<0.1 && mean(x[grep("PCT",colnames(Newdata))],na.rm=T)>0.4))  # Cancer tissue > 0 and normal plasma =0

length(target1.colon)
Newdata2=Newdata[target1.colon,]
write.table(NewData,file="pancrease.cancer.tissue.hyper.txt",col.names=NA,row.names=T,quote=F,sep="\t")

colonData=Newdata2
dim(colonData)
colnames(colonData)
NewData<-data.frame(value=as.numeric(colonData),Group=rep(colnames(colonData),each=nrow(colonData)))
myData <- aggregate(NewData$value,by =list(type=NewData$Group),
                    FUN = function(x) c(mean = mean(x,na.rm=T), 
                                        sd = sd(x,na.rm=T),
                                        sem=sd(x,na.rm=T)/sqrt(length(na.omit(x))),
                                        me=qt(1-0.05/2,df=length(na.omit(x))*sd(x,na.rm=T)/sqrt(length(na.omit(x)))))
)
myData <- do.call(data.frame, myData)
colnames(myData)=c("type","mean","sd","sem","me")
head(myData)

library("ggplot2")
# pdf("pancrease.cancer.mhl.plasma.groups.107.pdf")
ylab="Average MHL"
xlab="Group"
title="Average MHL in different Groups"
myData <- within(myData,type <- factor(type,levels=c("NP-Kun","NPT","PCT","PCP")))

ggplot(myData, aes(x =type, y = mean)) +  
  geom_bar(position = position_dodge(), stat="identity", fill="blue",width=0.9) + 
  geom_errorbar(aes(ymin=mean-sem, ymax=mean+sem),size=1.0) +
  ggtitle(title) + 
  theme_bw() +
  theme(panel.grid.major = element_blank())+
  xlab(xlab) +
  ylab(ylab)+
  theme(axis.text=element_text(size=10),axis.title=element_text(size=10),axis.text.y = element_text(hjust=0))
dev.off()

```



```{r}
rlt<-apply(newdata,1,function(x) tapply(x,idx,function(x) quantile(x,0.75,na.rm=T)))
save(rlt,file="MONOD-march30.MHL.median.by.idx.RData")
# feature selection # 1: CT> CP/NT and NT,NP,ONT<0.1
target<-c()
for(i in 1:ncol(rlt)){
  order=order(rlt[,i],decreasing=T)
  if(order==c(2,1,3,4,5,6) ||order==c(2,3,1,4,5,6)){
    if(rlt[2,i]>0.1 & rlt[4,i]<0.05 & rlt[5,i]<0.05 & rlt[6,i]<0.05 & ! all(is.na(rlt[2,i])) & ! all(is.na(rlt[4,i])) & ! all(is.na(rlt[5,i])) & ! all(is.na(rlt[6,i]))){
      print (i)
      target<-c(target,i)
    }
  } 
}
newdataGGplot<-newdata[match(colnames(rlt)[target],rownames(newdata)),]
length(target)
unique(colnames(newdataGGplot))

ggbarplot(newdataGGplot)
ggboxplot(newdataGGplot)

```


```{r}
# feature selection # 2: CT>0.2 and NP<0.05 and WB<0.05
# rlt<-apply(newdata,1,function(x) tapply(x,idx,function(x) mean(x,na.rm=T)))
target<-c()
for(i in 1:ncol(rlt)){
  if(! all(is.na(rlt[2,i])) & ! all(is.na(rlt[4,i])) & ! all(is.na(rlt[6,i])) & rlt[2,i]>0.2 & rlt[4,i]<0.1 & rlt[6,i]<0.1){
    print (i)
    target<-c(target,i)
  } 
}

# feature selection # 2: CT>0.5 and WB<0.1
# rlt<-apply(newdata,1,function(x) tapply(x,idx,function(x) mean(x,na.rm=T)))
target<-c()
for(i in 1:ncol(rlt)){
  if(! all(is.na(rlt[3,i])) & ! all(is.na(rlt[4,i])) & ! all(is.na(rlt[5,i])) & ! all(is.na(rlt[6,i])) & rlt[3,i]>0.5 & rlt[4,i]<0.1 & rlt[5,i]<0.1 & rlt[6,i]<0.1){
    print (i)
    target<-c(target,i)
  } 
}
length(target)
# ggplot for boxplot
newdataGGplot<-newdata[match(colnames(rlt)[target],rownames(newdata)),]
ggbarplot(newdataGGplot)
ggboxplot(newdataGGplot)

library("gplots")
newdataGGplot<-t(newdataGGplot)
heatmap.2(newdataGGplot,
           col = colorpanel(100,"red","yellow","green"),
           margins = c(12, 22),
           trace = "none", 
           xlab = "Comparison",
           lhei = c(2, 8),
           scale = c("none"),
           symbreaks = min(newdataGGplot, na.rm=TRUE),
           na.color="blue",
           cexRow = 0.5, cexCol = 0.7,
           main = "DE genes", 
           dendrogram = "both", 
           Colv = T,
           Rowv=T
           )

write.table(newdataGGplot,file="monond-colon-plasma.txt",col.names=NA,row.names=T,sep="\t",quote=F)
```


```{r, echo=FALSE}






```
